# **Семинар №4. Оптический поток в OpenCV**

## **Введение**

Цель семинара — закрепить ключевые идеи лекции: понимание видеоряда как динамического сигнала, вычисление пространственно-временных производных, получение разреженного и плотного оптического потока, анализ устойчивости методов в реальных условиях и применение потока как оператора связи между кадрами. Студент должен уметь загрузить видео, выделить ключевые точки, вычислить поток Лукаса–Канаде, получить плотный поток Фарнебэка, визуализировать его, интерпретировать структуру движения и выполнить базовые операции warping для компенсации движения. Семинар организован так, чтобы каждый шаг был воспроизводим и отражал реальные инженерные сценарии.

---

## **Задание 1. Пространственно-временные производные и разностные карты**

Загрузите видеоролик и выполните вычисление временной разности между соседними кадрами. Затем выполните сглаживание каждого кадра Гауссовым фильтром с регулируемой сигмой и оцените влияние сглаживания на структуру (I_t). Проведите эксперимент: выберите несколько значений (\sigma) и сравните разностные карты, объясняя, где сглаживание помогает (например, при шуме сенсора или компрессии), а где — ухудшает различимость движения из-за подавления локальных изменений. Постройте визуализацию, позволяющую в реальном времени наблюдать влияние параметров фильтра на качество карты (I_t).

---

## **Задание 2. Метод Лукаса–Канаде для набора точек**

Найдите на первом кадре видео угловые точки с использованием `cv2.goodFeaturesToTrack` и вычислите их оптический поток с помощью `cv2.calcOpticalFlowPyrLK`. Для каждой точки визуализируйте стрелку, соединяющую исходное положение и положение на следующем кадре. Затем искусственно измените параметры LK (размер окна, количество уровней пирамиды) и наблюдайте, как выбор параметров влияет на стабильность трека. Особое внимание уделите областям, где LK выходит из строя: зоны слабой текстуры, быстрые движения, motion blur, тени и отражения. В конце оцените, какие параметры дают наиболее устойчивое поведение на данном видео.

---

## **Задание 3. Плотный поток Фарнебэка и его интерпретация**

Вычислите плотный оптический поток Farnebäck для двух последовательных кадров. Визуализируйте его в HSV-формате, где оттенок отвечает за направление, а значение интенсивности — за модуль скорости. Проведите серию экспериментов с параметрами `winsize`, `poly_n`, `poly_sigma`, `levels` и `iterations`, наблюдая изменение гладкости, устойчивости и чувствительности потока. Объясните, почему слишком малые окна повышают чувствительность к шуму, а слишком большие приводят к «размыванию» структуры движения. Сравните результаты с LK и объясните, почему Фарнебэк продолжает давать поток даже там, где LK не находит точек.

---

## **Задание 4. Сегментация движущихся областей через модуль потока**

Используя плотный поток, вычислите карту амплитуды (M=\sqrt{u^2+v^2}) и выполните бинарную сегментацию движущихся объектов через порогирование. Примените морфологическую фильтрацию (открытие, закрытие) для удаления шумовых пикселей и заполнения дыр в сегментированных областях. Исследуйте влияние выбора порога на точность выделения областей движения. Объясните, почему одни участки дают корректные сегменты, а другие — ложные, связанные с тенями, бликами, глобальным движением камеры или шумом компрессии.

---

## **Задание 5. Компенсация движения через warping**

Используя плотный поток Фарнебэка, выполните обратный warping, чтобы деформировать второй кадр в координатную систему первого. Визуализируйте результат и оцените качество компенсации: насколько хорошо фон становится статичным, появляются ли разрывы или артефакты. Затем выполните эксперимент с последовательными кадрами: накопите конденсированный результат стабилизации, используя warping нескольких шагов. Объясните, в каких ситуациях warping работает корректно, а когда ошибки потока приводят к некорректным деформациям — например, в областях с недостаточной текстурой, в тенях или в регионах с сильным motion blur.

---

